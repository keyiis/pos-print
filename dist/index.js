"use strict";var __awaiter=this&&this.__awaiter||function(o,a,u,c){return new(u||(u=Promise))(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(r,n)}i((c=c.apply(o,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,o,a,e,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;u;)try{if(i=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){u.label=t[1];break}if(6===t[0]&&u.label<a[1]){u.label=a[1],a=t;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(t);break}a[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(r,u)}catch(e){t=[6,e],o=0}finally{i=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var printer=require("printer"),iconv=require("iconv-lite"),getPixels=require("get-pixels"),lodash_1=require("lodash"),PrintCmdType={ESC:"ESC/POS",TSC:"TSC"};function getPrinters(){return printer.getPrinters()}function printText(r,n){return new Promise(function(e,t){printer.printDirect({data:iconv.encode(n,"gbk"),type:"TEXT",printer:r,success:e,error:t})})}function printRaw(r,n){return new Promise(function(e,t){try{printer.printDirect({data:n,type:"RAW",printer:r,success:e,error:function(e){t(e)}})}catch(e){t(e)}})}function printImageByESC(i){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,img2Buffer((i=lodash_1.merge({copy:1},i)).url,PrintCmdType.ESC,i.maxWidth)];case 1:return t=e.sent(),(r=[]).push(iconv.encode("@","gbk")),[29,118,48,0,255&t.byteLength,t.byteLength>>8,255&t.height,t.height>>8].forEach(function(e){var t=new Buffer(1);t.writeUInt8(e,0),r.push(t)}),r.push(t.imgData),n=Buffer.concat(r),[4,printRaw(i.printer,n)];case 2:return e.sent(),[2]}})})}function printImageByTSC(i){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return[4,img2Buffer((i=lodash_1.merge({gap:2,copy:1},i)).url,PrintCmdType.TSC,i.pageWidth,i.pageHeight)];case 1:return t=e.sent(),(r=[]).push(iconv.encode("SIZE "+i.pageWidth+" mm,"+i.pageHeight+" mm\r\n","gbk")),r.push(iconv.encode("GAP "+(i.gap||2)+" mm,0 mm\r\n","gbk")),r.push(iconv.encode("CLS\r\n","gbk")),r.push(iconv.encode("BITMAP 0,0,"+t.byteLength+","+t.height+",0,","gbk")),r.push(t.imgData),r.push(iconv.encode("\r\nPRINT 1,"+Math.round(i.copy)+"\r\n","gbk")),n=Buffer.concat(r),[4,printRaw(i.printer,n)];case 2:return e.sent(),[2]}})})}function img2Buffer(l,g,d,m){return __awaiter(this,void 0,void 0,function(){var t,r,n,i,o,a,u,c,s,p,h,f;return __generator(this,function(e){switch(e.label){case 0:if(t=mm2Px(d),r=m?mm2Px(m):65635,!lodash_1.isString(l)&&lodash_1.isEmpty(l))throw new Error("Image dataurl invalid!");return[4,getPixelsByUrl(l)];case 1:if(n=e.sent(),i=n.shape[0],o=n.shape[1],t<i||r<o)throw new Error("Image width "+i+"px can't big then "+t+"px,height "+o+"px can't big then "+r+"px.");for(a=[],u=Math.ceil(i/8),c=0;c<o;c++)for(s=0;s<u;s++){for(h=p=0;h<8;h++)p+=calDotValue(g,n,c,s,h);(f=new Buffer(1)).writeUInt8(p,0),a.push(f)}return[2,{imgData:Buffer.concat(a),byteLength:u,width:i,height:o}]}})})}function mm2Px(e){return Math.round(8*e)}function getPixelsByUrl(e){return new Promise(function(r,n){getPixels(e,function(e,t){if(e)return n(e);r(t)})})}function calDotValue(e,t,r,n,i){var o=t.get(8*n+i,r,0),a=t.get(8*n+i,r,1),u=t.get(8*n+i,r,2);o/=255,a/=255,u/=255;var c=(Math.max(o,a,u)+Math.min(o,a,u))/2;return e==PrintCmdType.ESC?c<.6?1<<7-i:0:e==PrintCmdType.TSC?.6<=c?1<<7-i:0:void 0}exports.getPrinters=getPrinters,exports.printText=printText,exports.printRaw=printRaw,exports.printImageByESC=printImageByESC,exports.printImageByTSC=printImageByTSC;